package jan.edu.ed.client.forms;

import jan.edu.ed.client.ExploitDemoConstants;
import jan.edu.ed.client.services.LoginServiceAsync;
import jan.edu.ed.client.windows.PersonWindow;
import jan.edu.ed.shared.model.LoginCredentials;

import com.extjs.gxt.ui.client.Registry;
import com.extjs.gxt.ui.client.event.ButtonEvent;
import com.extjs.gxt.ui.client.event.SelectionListener;
import com.extjs.gxt.ui.client.widget.button.Button;
import com.extjs.gxt.ui.client.widget.form.FormPanel;
import com.extjs.gxt.ui.client.widget.form.TextField;
import com.google.gwt.user.client.Element;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.rpc.AsyncCallback;

public class LoginForm extends FormPanel {
	
	//Form fields
	private final TextField<String> loginField = new TextField<String>();
	private final TextField<String> passwordField = new TextField<String>();
	private final Button loginButton = new Button("Login");
	
	/**
	 * Create a new Login-Form
	 */
	public LoginForm(){
		setHeaderVisible(false);
		//Handle click to Login
		loginButton.addSelectionListener(new SelectionListener<ButtonEvent>() {
			@Override
			public void componentSelected(ButtonEvent ce) {
				final LoginServiceAsync loginService = Registry.get(ExploitDemoConstants.LOGIN_SERVICE);
				LoginCredentials lc = new LoginCredentials(loginField.getValue(),passwordField.getValue());
				loginService.login(lc, new AsyncCallback<Boolean>() {
					@Override
					public void onSuccess(Boolean result) {
						if(result)
							showEditPersonDialog();
						else
							Window.alert("Wrong Username or password");
					}
					
					@Override
					public void onFailure(Throwable caught) {
						Window.alert(caught.toString());
						
					}
				});
				
			}
		});
	}



	//On-Render - called for rendering
	@Override
	protected void onRender(Element target, int index) {
		super.onRender(target, index);
		loginField.setFieldLabel("Login");
		passwordField.setFieldLabel("Password");
		passwordField.setPassword(true);
		add(loginField);
		add(passwordField);
		add(loginButton);
		setHeight(120);
		setWidth(400);
	}
	
	//Show Dialog
	private void showEditPersonDialog(){
		final PersonWindow window = new PersonWindow();
		window.show();
	}

}
